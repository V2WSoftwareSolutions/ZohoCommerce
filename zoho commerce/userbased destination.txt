<script>
(function () {

    // ‚≠ê NEW: Global variable to store access token
    let ACCESS_TOKEN = "";

    // ‚≠ê NEW: Function to load access token from access_token.json
    async function loadAccessToken() {
        try {
            // Adjust path if your file is in a different folder
            const res = await fetch(`${window.location.origin}/destination/access_token.json?ts=${Date.now()}`, {
                cache: "no-store"
            });

            if (!res.ok) {
                console.error("HTTP error while fetching access_token.json:", res.status);
                return "";
            }

            const data = await res.json();
            const token = data?.access_token || "";
            ACCESS_TOKEN = token;         // save globally
            console.log("ACCESS_TOKEN loaded:", ACCESS_TOKEN);
            return token;
        } catch (err) {
            console.error("Error fetching access_token.json:", err);
            return "";
        }
    }

    // ===== 1) Get current user's destination ids from portaluser/userProfile =====
    async function getUserDestinationIds() {
        try {
            const res = await fetch('/portaluser/userProfile', {
                method: 'GET',
                credentials: 'include'
            });

            if (!res.ok) {
                console.error("HTTP error while fetching user profile:", res.status);
                return [];
            }

            const data = await res.json();
            console.log("Full user profile:", data);

            // üîπ CHANGED: read designation string, split into multiple IDs
            const designationStr = data?.payload?.contacts_zos_response?.contact?.designation || "";
            console.log("Raw designation string:", designationStr);

            // Split "id1,id2, id3" into ["id1", "id2", "id3"]
            const idList = designationStr
                .split(",")
                .map(s => s.trim())
                .filter(Boolean);

            console.log("Parsed destination IDs:", idList);

            // OPTIONAL: display raw value somewhere if needed
            const el = document.querySelector("#userDesignation");
            if (el) {
                el.textContent = designationStr;
            }

            return idList;
        } catch (err) {
            console.error("Error fetching profile:", err);
            return [];
        }
    }

    // ===== 2) Destination dropdown logic (filtered by user destination ids) =====
    async function loadDestinations() {
        // Avoid duplicates
        if (document.querySelector(".destination-container")) return;

        // Locate target container (checkout or edit form)
        const inputContainer =
            document.querySelector("[data-zs-input-container]") ||
            document.querySelector(".checkout-address-edit [data-zs-input-container]") ||
            document.querySelector(".theme-checkout-edit-form [data-zs-input-container]") ||
            document.querySelector("form[action*='checkout'] [data-zs-input-container]");

        if (!inputContainer) {
            console.warn("Destination container not yet available. Retrying...");
            setTimeout(loadDestinations, 800);
            return;
        }

        // ‚≠ê NEW: Load access token BEFORE calling user details
        await loadAccessToken();
        // You can use ACCESS_TOKEN anywhere after this in this function or others

        // --- 2.1) First, get user destination ids from profile ---
        const userDestinationIds = await getUserDestinationIds();  // üîπ CHANGED
        console.log("Using these destination IDs to filter:", userDestinationIds);

        // Create dropdown container
        const container = document.createElement("div");
        container.classList.add("destination-container");

        const label = document.createElement("label");
        label.textContent = "Select Destination:";

        const select = document.createElement("select");
        select.classList.add("destination-select");

        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "Loading destinations...";
        select.appendChild(defaultOption);

        container.appendChild(label);
        container.appendChild(select);
        inputContainer.appendChild(container);

        // Hide Destination ID field if it exists
        document.querySelectorAll('label.theme-text-color-light').forEach(label => {
            if (label.textContent.trim().includes('Destination ID')) {
                label.style.display = 'none';
                if (label.nextElementSibling) {
                    label.nextElementSibling.style.display = 'none';
                }
            }
        });

      // --- 2.2) Fetch destinations JSON and FILTER by userDestinationIds ---
        let destinations = [];
        try {
            const response = await fetch(`${window.location.origin}/destination/destination.json`);
            const data = await response.json();
            select.innerHTML = "";

            if (data?.data?.length) {
                const allDestinations = data.data;

                if (userDestinationIds.length > 0) {
                    // ‚úÖ Keep only destinations whose id is in user's designation list
                    destinations = allDestinations.filter(d =>
                        userDestinationIds.includes(String(d.id))
                    );
                } else {
                    // ‚ùå No designation IDs in user profile ‚Üí treat as "no destination"
                    destinations = [];
                }

                if (!destinations.length) {
                    // ‚úÖ Show proper validation message
                    const noMatchOption = document.createElement("option");
                    noMatchOption.value = "";
                    noMatchOption.textContent = (
                        userDestinationIds.length === 0
                            ? "No Destination ID is configured for your profile. Please contact support."
                            : "No destination mapped to your account."
                    );
                    noMatchOption.disabled = true;
                    noMatchOption.selected = true;
                    select.appendChild(noMatchOption);
                } else {
                    const placeholder = document.createElement("option");
                    placeholder.value = "";
                    placeholder.textContent = "Select a destination";
                    placeholder.disabled = true;
                    placeholder.selected = true;
                    select.appendChild(placeholder);

                    destinations.forEach(dest => {
                        const option = document.createElement("option");
                        option.value = dest.id;

                        const displayName = dest.name || dest.alias || "Unnamed";
                        const licenseText = dest.license_number ? ` (${dest.license_number})` : ` (No License)`;
                        option.textContent = displayName + licenseText;

                        select.appendChild(option);
                    });
                }
            } else {
                select.innerHTML = "<option>No destinations found</option>";
            }
        } catch (error) {
            console.error("Error fetching destinations:", error);
            select.innerHTML = "<option>Error loading destinations</option>";
        }
        // --- 2.3) Selection handler: fill checkout fields from selected destination ---
        select.addEventListener("change", () => {
            const selectedDest = destinations.find(d => String(d.id) === String(select.value));
            if (!selectedDest) return;

            const salesOrderFields = document.querySelectorAll("input[data-salesorder-customfield-id]");
            let field1 = null, field2 = null;

            salesOrderFields.forEach(field => {
                const fieldId = field.getAttribute("data-salesorder-customfield-id");
                if (fieldId == "7631921000000094128") field1 = field; // Destination ID field
                if (fieldId == "7631921000000094132") field2 = field; // Destination Name field
            });

            const addressField = document.querySelector("input[name='address'], textarea[name='address']");
            const cityField = document.querySelector("input[name='city']");
            const countryField = document.querySelector("input[name='country']");
            const stateField = document.querySelector("select[name='state']");
            const zipField = document.querySelector("input[name='postal_code']");
            const telephoneField = document.querySelector("input[name='telephone']");
            const firstNameField = document.querySelector("input[name='first_name'], input[name='firstname']");
            const lastNameField = document.querySelector("input[name='last_name'], input[name='lastname']");
            const emailField = document.querySelector("input[name='email'], input[name='email_address']");

            function setFieldValue(field, value) {
                if (field) {
                    field.value = value || "";
                    field.dispatchEvent(new Event("input", { bubbles: true }));
                    field.dispatchEvent(new Event("change", { bubbles: true }));
                }
            }

            [
                addressField, cityField, stateField, zipField, countryField,
                field1, field2, telephoneField, firstNameField, lastNameField, emailField
            ].forEach(f => setFieldValue(f, ""));

            const stateAbbreviations = {
                AL: "Alabama", AK: "Alaska", AZ: "Arizona", AR: "Arkansas", CA: "California",
                CO: "Colorado", CT: "Connecticut", DE: "Delaware", FL: "Florida", GA: "Georgia",
                HI: "Hawaii", ID: "Idaho", IL: "Illinois", IN: "Indiana", IA: "Iowa", KS: "Kansas",
                KY: "Kentucky", LA: "Louisiana", ME: "Maine", MD: "Maryland", MA: "Massachusetts",
                MI: "Michigan", MN: "Minnesota", MS: "Mississippi", MO: "Missouri", MT: "Montana",
                NE: "Nebraska", NV: "Nevada", NH: "New Hampshire", NJ: "New Jersey", NM: "New Mexico",
                NY: "New York", NC: "North Carolina", ND: "North Dakota", OH: "Ohio", OK: "Oklahoma",
                OR: "Oregon", PA: "Pennsylvania", RI: "Rhode Island", SC: "South Carolina",
                SD: "South Dakota", TN: "Tennessee", TX: "Texas", UT: "Utah", VT: "Vermont",
                VA: "Virginia", WA: "Washington", WV: "West Virginia", WI: "Wisconsin", WY: "Wyoming"
            };

            const abbreviation = selectedDest.state;

            setFieldValue(field1, selectedDest.id);
            setFieldValue(field2, selectedDest.name || selectedDest.alias || "Unnamed");
            setFieldValue(addressField, selectedDest.address_line_1);
            setFieldValue(cityField, selectedDest.city);
            setFieldValue(countryField, selectedDest.country);
            setTimeout(() => setFieldValue(stateField, abbreviation), 300);
            setFieldValue(zipField, selectedDest.postal_code || selectedDest.zip_code);

            if (Array.isArray(selectedDest.contacts) && selectedDest.contacts.length > 0) {
                const c = selectedDest.contacts.find(c => c.is_primary == 1) || selectedDest.contacts[0];
                setFieldValue(firstNameField, c.first_name);
                setFieldValue(lastNameField, c.last_name);
                setFieldValue(emailField, c.email);
                setFieldValue(telephoneField, c.phone_number);
            }
        });
    }

    // Run once on load
    document.addEventListener("DOMContentLoaded", loadDestinations);

    // Detect checkout edit modal or dynamic updates
    const observer = new MutationObserver(() => {
        if (!document.querySelector(".destination-container") &&
            document.querySelector("[data-zs-input-container]")) {
            console.log("üîÅ Edit checkout form detected, reloading destinations...");
            loadDestinations();
        }
    });
    observer.observe(document.body, { childList: true, subtree: true });

})();
</script>
